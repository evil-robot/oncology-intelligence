'use client'

import { useState, useEffect, useCallback } from 'react'
import { Moon, Sun, Clock, AlertTriangle, TrendingUp, Eye, EyeOff } from 'lucide-react'

interface HourlyData {
  term_id: number
  term: string
  hourly_avg: Record<string, number>
  day_of_week: Record<string, number>
  peak_hours: number[]
  anxiety_index: number
  late_night_avg: number
  daytime_avg: number
  demo_mode: boolean
}

interface AnxiousTermEntry {
  term_id: number
  term: string
  category: string
  cluster_id: number | null
  anxiety_index: number
  late_night_avg: number
  daytime_avg: number
  peak_hours: number[]
}

interface VulnerabilityWindowProps {
  selectedTermId?: number | null
  onTermSelect?: (termId: number) => void
}

const HOUR_LABELS = [
  '12a', '1a', '2a', '3a', '4a', '5a', '6a', '7a', '8a', '9a', '10a', '11a',
  '12p', '1p', '2p', '3p', '4p', '5p', '6p', '7p', '8p', '9p', '10p', '11p',
]

function getHeatColor(value: number, max: number): string {
  if (max === 0) return 'rgba(99, 102, 241, 0.1)'
  const intensity = value / max
  // Purple-to-hot gradient: low=cool purple, high=hot pink/red
  if (intensity < 0.25) return `rgba(99, 102, 241, ${0.15 + intensity * 0.6})`
  if (intensity < 0.5) return `rgba(139, 92, 246, ${0.3 + intensity * 0.5})`
  if (intensity < 0.75) return `rgba(217, 70, 239, ${0.5 + intensity * 0.4})`
  return `rgba(244, 63, 94, ${0.6 + intensity * 0.4})`
}

function formatHour(h: number): string {
  if (h === 0) return '12 AM'
  if (h < 12) return `${h} AM`
  if (h === 12) return '12 PM'
  return `${h - 12} PM`
}

export default function VulnerabilityWindow({ selectedTermId, onTermSelect }: VulnerabilityWindowProps) {
  const [hourlyData, setHourlyData] = useState<HourlyData | null>(null)
  const [topAnxious, setTopAnxious] = useState<AnxiousTermEntry[]>([])
  const [isExpanded, setIsExpanded] = useState(true)
  const [view, setView] = useState<'heatmap' | 'ranking'>('heatmap')
  const [loading, setLoading] = useState(false)

  const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'

  // Fetch hourly data for selected term
  const fetchHourlyData = useCallback(async (termId: number) => {
    setLoading(true)
    try {
      const response = await fetch(`${API_URL}/api/trends/vulnerability/${termId}`)
      if (response.ok) {
        const data = await response.json()
        setHourlyData(data)
      }
    } catch (err) {
      console.error('Failed to fetch hourly data:', err)
    }
    setLoading(false)
  }, [API_URL])

  // Fetch top anxious terms
  const fetchTopAnxious = useCallback(async () => {
    try {
      const response = await fetch(`${API_URL}/api/trends/vulnerability/top-anxious?limit=15`)
      if (response.ok) {
        const data = await response.json()
        setTopAnxious(data)
      }
    } catch (err) {
      console.error('Failed to fetch top anxious terms:', err)
    }
  }, [API_URL])

  useEffect(() => {
    fetchTopAnxious()
  }, [fetchTopAnxious])

  useEffect(() => {
    if (selectedTermId) {
      fetchHourlyData(selectedTermId)
    }
  }, [selectedTermId, fetchHourlyData])

  // Compute max value for heatmap scaling
  const maxHourly = hourlyData
    ? Math.max(...Object.values(hourlyData.hourly_avg).map(Number))
    : 0

  return (
    <div className="glass rounded-lg overflow-hidden">
      {/* Header */}
      <div
        className="p-3 flex items-center justify-between cursor-pointer hover:bg-surface/50 transition-colors"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <h3 className="text-sm font-medium text-gray-300 flex items-center gap-2">
          <Moon className="w-4 h-4 text-violet-400" />
          Search Anxiety Window
        </h3>
        <div className="flex items-center gap-2">
          {hourlyData && (
            <span className={`text-xs px-2 py-0.5 rounded-full ${
              hourlyData.anxiety_index > 1.2
                ? 'bg-red-500/20 text-red-400'
                : hourlyData.anxiety_index > 0.8
                  ? 'bg-yellow-500/20 text-yellow-400'
                  : 'bg-green-500/20 text-green-400'
            }`}>
              {hourlyData.anxiety_index > 1.2 ? 'High' : hourlyData.anxiety_index > 0.8 ? 'Moderate' : 'Low'} anxiety
            </span>
          )}
          {isExpanded ? <EyeOff className="w-3 h-3 text-gray-500" /> : <Eye className="w-3 h-3 text-gray-500" />}
        </div>
      </div>

      {isExpanded && (
        <div className="px-3 pb-3 space-y-3">
          {/* View toggle */}
          <div className="flex gap-1 bg-surface rounded-lg p-0.5">
            <button
              onClick={() => setView('heatmap')}
              className={`flex-1 text-xs py-1.5 rounded-md transition-all ${
                view === 'heatmap'
                  ? 'bg-violet-500/20 text-violet-400'
                  : 'text-gray-500 hover:text-gray-300'
              }`}
            >
              Hourly Heatmap
            </button>
            <button
              onClick={() => setView('ranking')}
              className={`flex-1 text-xs py-1.5 rounded-md transition-all ${
                view === 'ranking'
                  ? 'bg-violet-500/20 text-violet-400'
                  : 'text-gray-500 hover:text-gray-300'
              }`}
            >
              Most Anxious
            </button>
          </div>

          {view === 'heatmap' && (
            <>
              {/* Hourly Heatmap */}
              {hourlyData ? (
                <div className="space-y-2">
                  {/* Anxiety index badge */}
                  <div className="flex items-center justify-between">
                    <span className="text-xs text-gray-400 truncate max-w-[160px]" title={hourlyData.term}>
                      {hourlyData.term}
                    </span>
                    <div className="flex items-center gap-3 text-xs">
                      <span className="flex items-center gap-1 text-violet-400">
                        <Moon className="w-3 h-3" />
                        {hourlyData.late_night_avg}
                      </span>
                      <span className="flex items-center gap-1 text-yellow-400">
                        <Sun className="w-3 h-3" />
                        {hourlyData.daytime_avg}
                      </span>
                      <span className={`font-mono font-bold ${
                        hourlyData.anxiety_index > 1.2 ? 'text-red-400' :
                        hourlyData.anxiety_index > 0.8 ? 'text-yellow-400' : 'text-green-400'
                      }`}>
                        {hourlyData.anxiety_index}x
                      </span>
                    </div>
                  </div>

                  {/* 24-hour heatmap grid */}
                  <div className="relative">
                    {/* Late night highlight zone */}
                    <div className="absolute top-0 bottom-0 left-0 rounded-l-md"
                      style={{ width: `${(5/24) * 100}%`, background: 'rgba(139, 92, 246, 0.05)', borderRight: '1px dashed rgba(139, 92, 246, 0.2)' }}
                    />
                    <div className="absolute top-0 bottom-0 right-0 rounded-r-md"
                      style={{ width: `${(1/24) * 100}%`, background: 'rgba(139, 92, 246, 0.05)', borderLeft: '1px dashed rgba(139, 92, 246, 0.2)' }}
                    />

                    <div className="grid grid-cols-24 gap-px">
                      {Array.from({ length: 24 }, (_, h) => {
                        const value = Number(hourlyData.hourly_avg[h] || 0)
                        const isPeak = hourlyData.peak_hours?.includes(h)
                        const isLateNight = h >= 23 || h <= 4

                        return (
                          <div
                            key={h}
                            className="relative group"
                            style={{ gridColumn: `${h + 1} / ${h + 2}` }}
                          >
                            <div
                              className={`h-8 rounded-sm transition-all ${isPeak ? 'ring-1 ring-pink-400/50' : ''}`}
                              style={{ background: getHeatColor(value, maxHourly) }}
                            />
                            {/* Tooltip */}
                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:block z-50
                              bg-gray-900 border border-gray-700 rounded px-2 py-1 text-[10px] whitespace-nowrap pointer-events-none">
                              <div className="font-bold text-white">{formatHour(h)}</div>
                              <div className={isLateNight ? 'text-violet-400' : 'text-gray-400'}>
                                Interest: {value}
                                {isLateNight && ' ðŸŒ™'}
                              </div>
                            </div>
                          </div>
                        )
                      })}
                    </div>

                    {/* Hour labels */}
                    <div className="grid grid-cols-24 mt-1">
                      {HOUR_LABELS.map((label, i) => (
                        <div key={i} className={`text-[8px] text-center ${
                          i === 0 || i === 6 || i === 12 || i === 18
                            ? 'text-gray-400' : 'text-transparent'
                        }`}>
                          {label}
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Day of week mini chart */}
                  {hourlyData.day_of_week && (
                    <div className="flex items-end gap-1 h-8">
                      {Object.entries(hourlyData.day_of_week).map(([day, value]) => {
                        const maxDow = Math.max(...Object.values(hourlyData.day_of_week).map(Number))
                        const height = maxDow > 0 ? (Number(value) / maxDow) * 100 : 0
                        return (
                          <div key={day} className="flex-1 flex flex-col items-center gap-0.5">
                            <div
                              className="w-full rounded-t-sm bg-violet-500/30"
                              style={{ height: `${height}%`, minHeight: 2 }}
                            />
                            <span className="text-[8px] text-gray-500">{day.slice(0, 2)}</span>
                          </div>
                        )
                      })}
                    </div>
                  )}

                  {/* Insight text */}
                  <p className="text-[10px] text-gray-500 leading-relaxed">
                    {hourlyData.anxiety_index > 1.2
                      ? `People search for "${hourlyData.term}" significantly more at night (${hourlyData.peak_hours?.map(h => formatHour(h)).join(', ')}). This suggests high health anxiety driving late-night searches.`
                      : hourlyData.anxiety_index > 0.8
                        ? `Search activity for "${hourlyData.term}" is relatively even across day and night, with slight peaks at ${hourlyData.peak_hours?.map(h => formatHour(h)).join(', ')}.`
                        : `"${hourlyData.term}" is primarily searched during business hours, suggesting clinical/professional interest rather than patient anxiety.`
                    }
                  </p>
                </div>
              ) : (
                <div className="text-center py-4">
                  <Moon className="w-8 h-8 text-violet-400/30 mx-auto mb-2" />
                  <p className="text-xs text-gray-500">
                    {loading ? 'Loading hourly patterns...' : 'Select a term to see when people search'}
                  </p>
                  <p className="text-[10px] text-gray-600 mt-1">
                    Reveals late-night anxiety patterns
                  </p>
                </div>
              )}
            </>
          )}

          {view === 'ranking' && (
            <div className="space-y-1 max-h-64 overflow-y-auto">
              {topAnxious.length > 0 ? (
                topAnxious.map((entry, i) => (
                  <button
                    key={entry.term_id}
                    onClick={() => onTermSelect?.(entry.term_id)}
                    className={`w-full flex items-center gap-2 p-2 rounded-lg text-left transition-all hover:bg-surface/80 ${
                      selectedTermId === entry.term_id ? 'bg-violet-500/10 border border-violet-500/20' : ''
                    }`}
                  >
                    <span className={`text-xs font-mono w-6 text-center ${
                      i < 3 ? 'text-red-400 font-bold' : 'text-gray-500'
                    }`}>
                      {i + 1}
                    </span>
                    <div className="flex-1 min-w-0">
                      <div className="text-xs text-white truncate">{entry.term}</div>
                      <div className="text-[10px] text-gray-500">{entry.category}</div>
                    </div>
                    <div className="flex flex-col items-end">
                      <span className={`text-xs font-mono font-bold ${
                        entry.anxiety_index > 1.5 ? 'text-red-400' :
                        entry.anxiety_index > 1.2 ? 'text-orange-400' :
                        entry.anxiety_index > 0.8 ? 'text-yellow-400' : 'text-green-400'
                      }`}>
                        {entry.anxiety_index}x
                      </span>
                      <span className="text-[9px] text-gray-600">
                        peaks {entry.peak_hours?.slice(0, 2).map(h => formatHour(h)).join(', ')}
                      </span>
                    </div>
                  </button>
                ))
              ) : (
                <div className="text-center py-4">
                  <AlertTriangle className="w-6 h-6 text-gray-600 mx-auto mb-2" />
                  <p className="text-xs text-gray-500">
                    Run the pipeline to discover anxiety patterns
                  </p>
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  )
}
